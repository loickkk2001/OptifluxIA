<div class="dashboard-container p-4 md:p-6">
  <p-toast></p-toast>
  <p class="dashboard-title text-2xl md:text-3xl font-bold mb-6">Gestion des Utilisateurs</p>
  <div class="flex justify-end py-5">
    <p-button label="Ajouter un utilisateur" severity="contrast" (click)="openCreateUser()"></p-button>
  </div>

  <div class="flex flex-col md:flex-row gap-4 mb-6">
    <div class="flex-1">
      <span class="p-input-icon-left w-full">
        <input
          pInputText
          type="text"
          [(ngModel)]="searchTerm"
          (input)="applyFilter()"
          placeholder="Rechercher par nom, prénom, ou service..."
          class="w-full border border-gray-300 rounded-md focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors h-11"
        />
      </span>
    </div>
    <div class="w-full md:w-64">
      <p-dropdown
        [options]="roleOptions"
        [(ngModel)]="selectedRole"
        optionLabel="label"
        optionValue="value"
        (onChange)="applyFilter()"
        [showClear]="true"
        placeholder="Filtrer par rôle"
        styleClass="w-full border border-gray-300 rounded-md focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors h-11"
      ></p-dropdown>
    </div>
  </div>

  <div class="table-container overflow-x-auto rounded-lg">
    <p-table
      [value]="filteredUsers"
      [paginator]="true"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [lazy]="false"
      (onPage)="onPageChange($event)"
      [tableStyle]="{ 'min-width': '100%' }"
      responsiveLayout="scroll"
      class="w-full"
    >
      <ng-template pTemplate="header">
        <tr>
          <th class="p-3 bg-gray-200 font-semibold text-gray-700">Nom</th>
          <th class="p-3 bg-gray-200 font-semibold text-gray-700">Prénom</th>
          <th class="p-3 bg-gray-200 font-semibold text-gray-700">Téléphone</th>
          <th class="p-3 bg-gray-200 font-semibold text-gray-700">Email</th>
          <th class="p-3 bg-gray-200 font-semibold text-gray-700">Rôle</th>
          <th class="p-3 bg-gray-200 font-semibold text-gray-700">Service</th>
          <th class="p-3 bg-gray-200 font-semibold text-gray-700">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-user>
        <tr class="hover:bg-gray-50">
          <td class="p-3 border-b">{{ user.first_name }}</td>
          <td class="p-3 border-b">{{ user.last_name }}</td>
          <td class="p-3 border-b">{{ user.phoneNumber }}</td>
          <td class="p-3 border-b">{{ user.email }}</td>
          <td class="p-3 border-b">{{ user.role }}</td>
          <td class="p-3 border-b">{{ user.serviceName }}</td>
          <td class="p-3 border-b space-x-3">
            <i class="pi pi-pencil cursor-pointer text-blue-500 hover:text-blue-700" (click)="editUser(user)"></i>
            <i class="pi pi-trash cursor-pointer text-red-500 hover:text-red-700" (click)="confirmDelete(user)"></i>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [colSpan]="filteredUsers.length" class="text-center py-4 justify-center">
            Aucun Utilisateur
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-drawer
    [visible]="drawerVisible()"
    (visibleChange)="drawerVisible.set($event)"
    position="right"
    [header]="isEditMode ? 'Modifier l\'utilisateur' : 'Ajouter un utilisateur'"
  >
    <div class="flex flex-col gap-4" [formGroup]="userForm">
      <p-iftalabel>
        <input pInputText id="first_name" formControlName="first_name" autocomplete="off" class="w-full border rounded-md p-2" />
        <label for="first_name">Nom *</label>
        <small *ngIf="userForm.get('first_name')?.touched && userForm.get('first_name')?.invalid" class="text-red-500">
          Le nom est requis (min. 3 caractères).
        </small>
      </p-iftalabel>

      <p-iftalabel>
        <input pInputText id="last_name" formControlName="last_name" autocomplete="off" class="w-full border rounded-md p-2" />
        <label for="last_name">Prénom *</label>
        <small *ngIf="userForm.get('last_name')?.touched && userForm.get('last_name')?.invalid" class="text-red-500">
          Le prénom est requis (min. 3 caractères).
        </small>
      </p-iftalabel>

      <p-iftalabel>
        <p-select
          [options]="roleOptions"
          [filter]="true"
          id="role"
          optionLabel="label"
          optionValue="value"
          placeholder="Sélectionner un rôle"
          class="w-full"
          formControlName="role"
        />
        <label for="role">Rôle *</label>
        <small *ngIf="userForm.get('role')?.touched && userForm.get('role')?.invalid" class="text-red-500">
          Le rôle est requis.
        </small>
      </p-iftalabel>

      <p-iftalabel>
        <p-select
          [options]="services"
          [filter]="true"
          id="service"
          optionLabel="name"
          optionValue="id"
          placeholder="Sélectionner un service"
          class="w-full"
          formControlName="service"
        />
        <label for="service">Service</label>
      </p-iftalabel>

      <p-iftalabel>
        <input pInputText id="tel" formControlName="tel" autocomplete="off" class="w-full border rounded-md p-2" />
        <label for="tel">Téléphone *</label>
        <small *ngIf="userForm.get('tel')?.touched && userForm.get('tel')?.invalid" class="text-red-500">
          Numéro invalide (10 chiffres requis).
        </small>
      </p-iftalabel>

      <p-iftalabel>
        <input pInputText id="email" formControlName="email" autocomplete="off" class="w-full border rounded-md p-2" />
        <label for="email">Email *</label>
        <small *ngIf="userForm.get('email')?.touched && userForm.get('email')?.invalid" class="text-red-500">
          Email invalide ou requis.
        </small>
      </p-iftalabel>

      <p-iftalabel>
        <p-password
          id="password"
          formControlName="password"
          [toggleMask]="true"
          autocomplete="off"
          class="w-full"
          [style]="{ width: '100%' }"
          [inputStyle]="{ width: '100%' }"
        ></p-password>
        <label for="password">Mot de passe {{ isEditMode ? '(optionnel)' : '*' }}</label>
        <small *ngIf="userForm.get('password')?.touched && userForm.get('password')?.invalid" class="text-red-500">
          Le mot de passe doit contenir au moins 8 caractères.
        </small>
      </p-iftalabel>

      <div class="flex justify-end gap-2">
        <p-button label="Annuler" severity="secondary" (click)="closeDrawer()" />
        <p-button
          [label]="isEditMode ? 'Mettre à jour' : 'Ajouter'"
          severity="contrast"
          (click)="onSubmit()"
          [disabled]="loading() || userForm.invalid"
        />
      </div>
    </div>
  </p-drawer>

  <p-confirmDialog></p-confirmDialog>
</div>